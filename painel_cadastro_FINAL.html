<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BPO Financeiro - Cadastro de Cliente</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .step-active { background-color: #3B82F6; color: white; }
        .step-complete { background-color: #10B981; color: white; }
        .step-pending { background-color: #E5E7EB; color: #6B7280; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    
    <!-- Header -->
    <header class="bg-white shadow-sm border-b">
        <div class="max-w-4xl mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center">
                        <span class="text-white font-bold text-lg">BF</span>
                    </div>
                    <div>
                        <h1 class="text-xl font-semibold text-gray-900">BPO Financeiro</h1>
                        <p class="text-sm text-gray-500">Cadastro de Novo Cliente</p>
                    </div>
                </div>
                <span class="text-sm text-gray-400" id="dataAtual"></span>
            </div>
        </div>
    </header>

    <!-- Progress Steps -->
    <div class="max-w-4xl mx-auto px-4 py-6">
        <div class="flex items-center justify-center space-x-4">
            <div class="flex items-center">
                <div id="step1-indicator" class="w-8 h-8 rounded-full flex items-center justify-center text-sm font-medium step-active">1</div>
                <span class="ml-2 text-sm font-medium text-gray-700">Dados B√°sicos</span>
            </div>
            <div class="w-12 h-0.5 bg-gray-300"></div>
            <div class="flex items-center">
                <div id="step2-indicator" class="w-8 h-8 rounded-full flex items-center justify-center text-sm font-medium step-pending">2</div>
                <span class="ml-2 text-sm font-medium text-gray-500">Omie</span>
            </div>
            <div class="w-12 h-0.5 bg-gray-300"></div>
            <div class="flex items-center">
                <div id="step3-indicator" class="w-8 h-8 rounded-full flex items-center justify-center text-sm font-medium step-pending">3</div>
                <span class="ml-2 text-sm font-medium text-gray-500">Configura√ß√µes</span>
            </div>
            <div class="w-12 h-0.5 bg-gray-300"></div>
            <div class="flex items-center">
                <div id="step4-indicator" class="w-8 h-8 rounded-full flex items-center justify-center text-sm font-medium step-pending">4</div>
                <span class="ml-2 text-sm font-medium text-gray-500">Confirma√ß√£o</span>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="max-w-4xl mx-auto px-4 pb-12">
        
        <!-- Step 1: Dados B√°sicos -->
        <div id="step1" class="bg-white rounded-xl shadow-sm border p-6">
            <h2 class="text-lg font-semibold text-gray-900 mb-1">Dados da Empresa</h2>
            <p class="text-sm text-gray-500 mb-6">Informa√ß√µes b√°sicas do cliente</p>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Raz√£o Social -->
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        Raz√£o Social <span class="text-red-500">*</span>
                    </label>
                    <input type="text" id="razaoSocial" 
                           class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                           placeholder="Nome completo da empresa">
                </div>
                
                <!-- Nome Fantasia -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nome Fantasia</label>
                    <input type="text" id="nomeFantasia" 
                           class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                           placeholder="Nome comercial">
                </div>
                
                <!-- CNPJ -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        CNPJ <span class="text-red-500">*</span>
                    </label>
                    <input type="text" id="cnpj" 
                           class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                           placeholder="00.000.000/0001-00"
                           maxlength="18">
                </div>
                
                <!-- Respons√°vel -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        Nome do Respons√°vel <span class="text-red-500">*</span>
                    </label>
                    <input type="text" id="responsavelNome" 
                           class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                           placeholder="Nome completo">
                </div>
                
                <!-- Email Respons√°vel -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        Email do Respons√°vel <span class="text-red-500">*</span>
                    </label>
                    <input type="email" id="responsavelEmail" 
                           class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                           placeholder="email@empresa.com">
                </div>
                
                <!-- Telefone -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Telefone</label>
                    <input type="text" id="telefone" 
                           class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                           placeholder="(00) 00000-0000"
                           maxlength="15">
                </div>
            </div>
            
            <div class="mt-8 flex justify-end">
                <button onclick="nextStep(1)" 
                        class="px-6 py-2.5 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition-colors">
                    Pr√≥ximo ‚Üí
                </button>
            </div>
        </div>

        <!-- Step 2: Credenciais Omie -->
        <div id="step2" class="bg-white rounded-xl shadow-sm border p-6 hidden">
            <h2 class="text-lg font-semibold text-gray-900 mb-1">Integra√ß√£o com Omie</h2>
            <p class="text-sm text-gray-500 mb-6">Credenciais da API do Omie do cliente</p>
            
            <!-- Alerta informativo -->
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                <div class="flex">
                    <svg class="w-5 h-5 text-blue-600 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                    </svg>
                    <div class="ml-3">
                        <h3 class="text-sm font-medium text-blue-800">Como obter as credenciais?</h3>
                        <p class="text-sm text-blue-700 mt-1">
                            No Omie do cliente, acesse: <strong>Configura√ß√µes ‚Üí Integra√ß√µes ‚Üí API</strong> e copie a App Key e App Secret.
                        </p>
                    </div>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- App Key -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        App Key <span class="text-red-500">*</span>
                    </label>
                    <input type="text" id="omieAppKey" 
                           class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 font-mono"
                           placeholder="000000000000">
                </div>
                
                <!-- App Secret -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        App Secret <span class="text-red-500">*</span>
                    </label>
                    <input type="password" id="omieAppSecret" 
                           class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 font-mono"
                           placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    <button type="button" onclick="togglePassword('omieAppSecret')" 
                            class="text-sm text-blue-600 hover:text-blue-800 mt-1">
                        Mostrar/Ocultar
                    </button>
                </div>
            </div>
            
            <!-- Bot√£o Testar Conex√£o -->
            <div class="mt-6">
                <button onclick="testarConexaoOmie()" id="btnTestarConexao"
                        class="px-4 py-2 bg-gray-100 text-gray-700 font-medium rounded-lg hover:bg-gray-200 transition-colors border">
                    üîå Testar Conex√£o com Omie
                </button>
                <div id="resultadoTeste" class="mt-3 hidden"></div>
            </div>
            
            <div class="mt-8 flex justify-between">
                <button onclick="prevStep(2)" 
                        class="px-6 py-2.5 bg-gray-100 text-gray-700 font-medium rounded-lg hover:bg-gray-200 transition-colors">
                    ‚Üê Voltar
                </button>
                <button onclick="nextStep(2)" 
                        class="px-6 py-2.5 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition-colors">
                    Pr√≥ximo ‚Üí
                </button>
            </div>
        </div>

        <!-- Step 3: Configura√ß√µes -->
        <div id="step3" class="bg-white rounded-xl shadow-sm border p-6 hidden">
            <h2 class="text-lg font-semibold text-gray-900 mb-1">Configura√ß√µes de Opera√ß√£o</h2>
            <p class="text-sm text-gray-500 mb-6">Como os documentos ser√£o recebidos e processados</p>
            
            <div class="space-y-6">
                <!-- Canal de Entrada -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-3">
                        Canais de Recebimento de Boletos
                    </label>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <label class="flex items-center p-4 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="checkbox" id="canalEmail" checked class="w-4 h-4 text-blue-600">
                            <span class="ml-3">
                                <span class="block text-sm font-medium text-gray-900">üìß Email</span>
                                <span class="block text-xs text-gray-500">Encaminhar boletos por email</span>
                            </span>
                        </label>
                        <label class="flex items-center p-4 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="checkbox" id="canalWhatsApp" class="w-4 h-4 text-blue-600">
                            <span class="ml-3">
                                <span class="block text-sm font-medium text-gray-900">üí¨ WhatsApp</span>
                                <span class="block text-xs text-gray-500">Enviar pelo WhatsApp</span>
                            </span>
                        </label>
                        <label class="flex items-center p-4 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="checkbox" id="canalAPI" class="w-4 h-4 text-blue-600">
                            <span class="ml-3">
                                <span class="block text-sm font-medium text-gray-900">üîó API</span>
                                <span class="block text-xs text-gray-500">Integra√ß√£o direta</span>
                            </span>
                        </label>
                    </div>
                </div>
                
                <!-- Email de Entrada (condicional) -->
                <div id="configEmail">
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        Email para Receber Boletos
                    </label>
                    <input type="email" id="emailEntrada" 
                           class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                           placeholder="boletos.cliente@seudominio.com">
                    <p class="text-xs text-gray-500 mt-1">Cliente encaminhar√° boletos para este email</p>
                </div>
                
                <!-- WhatsApp (condicional) -->
                <div id="configWhatsApp" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        N√∫mero WhatsApp do Cliente
                    </label>
                    <input type="text" id="whatsappNumero" 
                           class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                           placeholder="5511999999999">
                </div>
                
                <!-- Confer√™ncia -->
                <div class="border-t pt-6">
                    <label class="block text-sm font-medium text-gray-700 mb-3">
                        Modo de Confer√™ncia
                    </label>
                    <div class="space-y-3">
                        <label class="flex items-start p-4 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="radio" name="modoConferencia" value="manual" checked 
                                   class="w-4 h-4 text-blue-600 mt-0.5">
                            <span class="ml-3">
                                <span class="block text-sm font-medium text-gray-900">Confer√™ncia Manual (Recomendado)</span>
                                <span class="block text-xs text-gray-500">Usu√°rio revisa e aprova antes do lan√ßamento</span>
                            </span>
                        </label>
                        <label class="flex items-start p-4 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="radio" name="modoConferencia" value="automatico" 
                                   class="w-4 h-4 text-blue-600 mt-0.5">
                            <span class="ml-3">
                                <span class="block text-sm font-medium text-gray-900">Lan√ßamento Autom√°tico</span>
                                <span class="block text-xs text-gray-500">Lan√ßa direto sem confer√™ncia (apenas erros s√£o revisados)</span>
                            </span>
                        </label>
                    </div>
                </div>
                
                <!-- Emails de Notifica√ß√£o -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        Emails para Notifica√ß√µes e Relat√≥rios
                    </label>
                    <input type="text" id="emailsNotificacao" 
                           class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                           placeholder="email1@empresa.com, email2@empresa.com">
                    <p class="text-xs text-gray-500 mt-1">Separe m√∫ltiplos emails por v√≠rgula</p>
                </div>
                
                <!-- Hor√°rios -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            Hor√°rio do Email de Confer√™ncia
                        </label>
                        <input type="time" id="horarioConferencia" value="17:00"
                               class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            Hor√°rio do Lan√ßamento Autom√°tico
                        </label>
                        <input type="time" id="horarioLancamento" value="08:00"
                               class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
            </div>
            
            <div class="mt-8 flex justify-between">
                <button onclick="prevStep(3)" 
                        class="px-6 py-2.5 bg-gray-100 text-gray-700 font-medium rounded-lg hover:bg-gray-200 transition-colors">
                    ‚Üê Voltar
                </button>
                <button onclick="nextStep(3)" 
                        class="px-6 py-2.5 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition-colors">
                    Pr√≥ximo ‚Üí
                </button>
            </div>
        </div>

        <!-- Step 4: Confirma√ß√£o -->
        <div id="step4" class="bg-white rounded-xl shadow-sm border p-6 hidden">
            <h2 class="text-lg font-semibold text-gray-900 mb-1">Confirmar Cadastro</h2>
            <p class="text-sm text-gray-500 mb-6">Revise os dados antes de finalizar</p>
            
            <div class="space-y-6">
                <!-- Resumo Empresa -->
                <div class="bg-gray-50 rounded-lg p-4">
                    <h3 class="text-sm font-semibold text-gray-700 mb-3">üìã Dados da Empresa</h3>
                    <dl class="grid grid-cols-2 gap-x-4 gap-y-2 text-sm">
                        <dt class="text-gray-500">Raz√£o Social:</dt>
                        <dd id="resumoRazaoSocial" class="font-medium text-gray-900">-</dd>
                        <dt class="text-gray-500">CNPJ:</dt>
                        <dd id="resumoCnpj" class="font-medium text-gray-900">-</dd>
                        <dt class="text-gray-500">Respons√°vel:</dt>
                        <dd id="resumoResponsavel" class="font-medium text-gray-900">-</dd>
                        <dt class="text-gray-500">Email:</dt>
                        <dd id="resumoEmail" class="font-medium text-gray-900">-</dd>
                    </dl>
                </div>
                
                <!-- Resumo Omie -->
                <div class="bg-gray-50 rounded-lg p-4">
                    <h3 class="text-sm font-semibold text-gray-700 mb-3">üîå Integra√ß√£o Omie</h3>
                    <dl class="grid grid-cols-2 gap-x-4 gap-y-2 text-sm">
                        <dt class="text-gray-500">App Key:</dt>
                        <dd id="resumoAppKey" class="font-medium text-gray-900 font-mono">-</dd>
                        <dt class="text-gray-500">Conex√£o:</dt>
                        <dd id="resumoConexao" class="font-medium">-</dd>
                    </dl>
                </div>
                
                <!-- Resumo Configura√ß√µes -->
                <div class="bg-gray-50 rounded-lg p-4">
                    <h3 class="text-sm font-semibold text-gray-700 mb-3">‚öôÔ∏è Configura√ß√µes</h3>
                    <dl class="grid grid-cols-2 gap-x-4 gap-y-2 text-sm">
                        <dt class="text-gray-500">Canais:</dt>
                        <dd id="resumoCanais" class="font-medium text-gray-900">-</dd>
                        <dt class="text-gray-500">Confer√™ncia:</dt>
                        <dd id="resumoConferencia" class="font-medium text-gray-900">-</dd>
                        <dt class="text-gray-500">Notifica√ß√µes:</dt>
                        <dd id="resumoNotificacoes" class="font-medium text-gray-900">-</dd>
                    </dl>
                </div>
                
                <!-- Observa√ß√µes -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        Observa√ß√µes do Onboarding (opcional)
                    </label>
                    <textarea id="observacoes" rows="3"
                              class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                              placeholder="Anota√ß√µes sobre o cliente, particularidades, etc."></textarea>
                </div>
            </div>
            
            <div class="mt-8 flex justify-between">
                <button onclick="prevStep(4)" 
                        class="px-6 py-2.5 bg-gray-100 text-gray-700 font-medium rounded-lg hover:bg-gray-200 transition-colors">
                    ‚Üê Voltar
                </button>
                <button onclick="salvarCliente()" id="btnSalvar"
                        class="px-8 py-2.5 bg-green-600 text-white font-medium rounded-lg hover:bg-green-700 transition-colors">
                    ‚úì Cadastrar Cliente
                </button>
            </div>
        </div>

        <!-- Step 5: Sucesso -->
        <div id="step5" class="bg-white rounded-xl shadow-sm border p-8 hidden text-center">
            <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                </svg>
            </div>
            <h2 class="text-2xl font-semibold text-gray-900 mb-2">Cliente Cadastrado!</h2>
            <p class="text-gray-600 mb-6">O cliente foi adicionado com sucesso ao sistema.</p>
            
            <div class="bg-blue-50 rounded-lg p-4 text-left max-w-md mx-auto mb-6">
                <h3 class="text-sm font-semibold text-blue-800 mb-2">üìã Pr√≥ximos Passos:</h3>
                <ol class="text-sm text-blue-700 space-y-1 list-decimal list-inside">
                    <li>Cadastrar fornecedores no Omie do cliente</li>
                    <li>Importar fornecedores para o sistema (autom√°tico)</li>
                    <li>Configurar email de encaminhamento</li>
                    <li>Fazer teste com um boleto</li>
                </ol>
            </div>
            
            <div class="flex justify-center space-x-4">
                <button onclick="window.location.reload()" 
                        class="px-6 py-2.5 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition-colors">
                    + Cadastrar Outro Cliente
                </button>
                <a href="#" 
                   class="px-6 py-2.5 bg-gray-100 text-gray-700 font-medium rounded-lg hover:bg-gray-200 transition-colors">
                    Ver Lista de Clientes
                </a>
            </div>
        </div>

    </main>

    <script>
        // Configura√ß√£o - ALTERE PARA SEU WEBHOOK N8N
        const CONFIG = {
            webhookUrl: 'https://n8n.vionflow.com.br/webhook/cadastro-cliente',
            supabaseUrl: 'https://anlmxxxulbrqoyyigadc.supabase.co',
            supabaseKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFubG14eHh1bGJycW95eWlnYWRjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkxMDEyODEsImV4cCI6MjA4NDY3NzI4MX0.SoltPhZUIW80B7Sk20iGSThB_a6tvjRlfRIQUlaUA-s'
        };

        // Estado do formul√°rio
        let currentStep = 1;
        let conexaoTestada = false;
        let dadosFormulario = {};

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', () => {
            // Data atual
            document.getElementById('dataAtual').textContent = new Date().toLocaleDateString('pt-BR', {
                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
            });

            // M√°scaras
            document.getElementById('cnpj').addEventListener('input', (e) => {
                e.target.value = formatarCNPJ(e.target.value);
            });
            document.getElementById('telefone').addEventListener('input', (e) => {
                e.target.value = formatarTelefone(e.target.value);
            });

            // Toggle canais
            document.getElementById('canalEmail').addEventListener('change', toggleCanais);
            document.getElementById('canalWhatsApp').addEventListener('change', toggleCanais);
        });

        function formatarCNPJ(valor) {
            return valor
                .replace(/\D/g, '')
                .replace(/(\d{2})(\d)/, '$1.$2')
                .replace(/(\d{3})(\d)/, '$1.$2')
                .replace(/(\d{3})(\d)/, '$1/$2')
                .replace(/(\d{4})(\d)/, '$1-$2')
                .substring(0, 18);
        }

        function formatarTelefone(valor) {
            return valor
                .replace(/\D/g, '')
                .replace(/(\d{2})(\d)/, '($1) $2')
                .replace(/(\d{5})(\d)/, '$1-$2')
                .substring(0, 15);
        }

        function toggleCanais() {
            document.getElementById('configEmail').classList.toggle('hidden', !document.getElementById('canalEmail').checked);
            document.getElementById('configWhatsApp').classList.toggle('hidden', !document.getElementById('canalWhatsApp').checked);
        }

        function togglePassword(fieldId) {
            const field = document.getElementById(fieldId);
            field.type = field.type === 'password' ? 'text' : 'password';
        }

        function updateStepIndicators() {
            for (let i = 1; i <= 4; i++) {
                const indicator = document.getElementById(`step${i}-indicator`);
                indicator.classList.remove('step-active', 'step-complete', 'step-pending');
                
                if (i < currentStep) {
                    indicator.classList.add('step-complete');
                    indicator.innerHTML = '‚úì';
                } else if (i === currentStep) {
                    indicator.classList.add('step-active');
                    indicator.innerHTML = i;
                } else {
                    indicator.classList.add('step-pending');
                    indicator.innerHTML = i;
                }
            }
        }

        function showStep(step) {
            for (let i = 1; i <= 5; i++) {
                document.getElementById(`step${i}`).classList.add('hidden');
            }
            document.getElementById(`step${step}`).classList.remove('hidden');
            currentStep = step;
            updateStepIndicators();
        }

        function nextStep(fromStep) {
            if (!validarStep(fromStep)) return;
            
            if (fromStep === 3) {
                atualizarResumo();
            }
            
            showStep(fromStep + 1);
        }

        function prevStep(fromStep) {
            showStep(fromStep - 1);
        }

        function validarStep(step) {
            let valid = true;
            let mensagem = '';

            if (step === 1) {
                if (!document.getElementById('razaoSocial').value.trim()) {
                    mensagem = 'Preencha a Raz√£o Social';
                    valid = false;
                } else if (!document.getElementById('cnpj').value.trim() || document.getElementById('cnpj').value.length < 18) {
                    mensagem = 'Preencha o CNPJ completo';
                    valid = false;
                } else if (!document.getElementById('responsavelNome').value.trim()) {
                    mensagem = 'Preencha o nome do respons√°vel';
                    valid = false;
                } else if (!document.getElementById('responsavelEmail').value.trim()) {
                    mensagem = 'Preencha o email do respons√°vel';
                    valid = false;
                }
            }

            if (step === 2) {
                if (!document.getElementById('omieAppKey').value.trim()) {
                    mensagem = 'Preencha a App Key do Omie';
                    valid = false;
                } else if (!document.getElementById('omieAppSecret').value.trim()) {
                    mensagem = 'Preencha o App Secret do Omie';
                    valid = false;
                }
            }

            if (!valid) {
                alert(mensagem);
            }

            return valid;
        }

        async function testarConexaoOmie() {
            const appKey = document.getElementById('omieAppKey').value.trim();
            const appSecret = document.getElementById('omieAppSecret').value.trim();
            
            if (!appKey || !appSecret) {
                alert('Preencha a App Key e App Secret');
                return;
            }

            const btn = document.getElementById('btnTestarConexao');
            const resultado = document.getElementById('resultadoTeste');
            
            btn.disabled = true;
            btn.textContent = '‚è≥ Testando...';
            resultado.classList.remove('hidden');
            resultado.innerHTML = '<p class="text-gray-600">Conectando ao Omie...</p>';

            try {
                // Testa listando empresas (endpoint simples)
                const response = await fetch('https://app.omie.com.br/api/v1/geral/empresas/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        call: 'ListarEmpresas',
                        app_key: appKey,
                        app_secret: appSecret,
                        param: [{ pagina: 1, registros_por_pagina: 1 }]
                    })
                });

                const data = await response.json();

                if (data.empresas_cadastro || data.codigo_status === 0) {
                    conexaoTestada = true;
                    resultado.innerHTML = `
                        <div class="flex items-center text-green-700 bg-green-50 p-3 rounded-lg">
                            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                            </svg>
                            <span>Conex√£o OK! Empresa: <strong>${data.empresas_cadastro?.[0]?.nome_fantasia || 'Conectado'}</strong></span>
                        </div>
                    `;
                } else {
                    throw new Error(data.faultstring || 'Erro desconhecido');
                }
            } catch (error) {
                conexaoTestada = false;
                resultado.innerHTML = `
                    <div class="flex items-center text-red-700 bg-red-50 p-3 rounded-lg">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                        </svg>
                        <span>Erro: ${error.message}</span>
                    </div>
                `;
            }

            btn.disabled = false;
            btn.textContent = 'üîå Testar Conex√£o com Omie';
        }

        function atualizarResumo() {
            // Dados b√°sicos
            document.getElementById('resumoRazaoSocial').textContent = document.getElementById('razaoSocial').value;
            document.getElementById('resumoCnpj').textContent = document.getElementById('cnpj').value;
            document.getElementById('resumoResponsavel').textContent = document.getElementById('responsavelNome').value;
            document.getElementById('resumoEmail').textContent = document.getElementById('responsavelEmail').value;

            // Omie
            const appKey = document.getElementById('omieAppKey').value;
            document.getElementById('resumoAppKey').textContent = appKey.substring(0, 4) + '****' + appKey.substring(appKey.length - 4);
            document.getElementById('resumoConexao').innerHTML = conexaoTestada 
                ? '<span class="text-green-600">‚úì Testada</span>' 
                : '<span class="text-yellow-600">‚ö† N√£o testada</span>';

            // Configura√ß√µes
            const canais = [];
            if (document.getElementById('canalEmail').checked) canais.push('Email');
            if (document.getElementById('canalWhatsApp').checked) canais.push('WhatsApp');
            if (document.getElementById('canalAPI').checked) canais.push('API');
            document.getElementById('resumoCanais').textContent = canais.join(', ') || 'Nenhum';

            const modoConferencia = document.querySelector('input[name="modoConferencia"]:checked').value;
            document.getElementById('resumoConferencia').textContent = modoConferencia === 'manual' ? 'Manual' : 'Autom√°tico';

            document.getElementById('resumoNotificacoes').textContent = document.getElementById('emailsNotificacao').value || 'N√£o configurado';
        }

        async function salvarCliente() {
            const btn = document.getElementById('btnSalvar');
            btn.disabled = true;
            btn.textContent = '‚è≥ Salvando...';

            // Monta os dados
            dadosFormulario = {
                // Dados b√°sicos
                razao_social: document.getElementById('razaoSocial').value.trim(),
                nome_fantasia: document.getElementById('nomeFantasia').value.trim() || null,
                cnpj: document.getElementById('cnpj').value.trim(),
                responsavel_nome: document.getElementById('responsavelNome').value.trim(),
                responsavel_email: document.getElementById('responsavelEmail').value.trim(),
                telefone: document.getElementById('telefone').value.trim() || null,

                // Omie
                omie_app_key: document.getElementById('omieAppKey').value.trim(),
                omie_app_secret: document.getElementById('omieAppSecret').value.trim(),
                omie_conexao_testada: conexaoTestada,

                // Configura√ß√µes
                email_entrada: document.getElementById('canalEmail').checked ? document.getElementById('emailEntrada').value.trim() : null,
                whatsapp_numero: document.getElementById('canalWhatsApp').checked ? document.getElementById('whatsappNumero').value.trim() : null,
                conferencia_automatica: document.querySelector('input[name="modoConferencia"]:checked').value === 'automatico',
                conferencia_horario: document.getElementById('horarioConferencia').value + ':00',
                lancamento_horario: document.getElementById('horarioLancamento').value + ':00',
                emails_notificacao: document.getElementById('emailsNotificacao').value.split(',').map(e => e.trim()).filter(e => e),
                conferencia_emails: document.getElementById('emailsNotificacao').value.split(',').map(e => e.trim()).filter(e => e),

                // Observa√ß√µes
                observacoes_onboarding: document.getElementById('observacoes').value.trim() || null,

                // Controle
                status_onboarding: 'configurando',
                ativo: false
            };

            try {
                // Envia para o webhook do n8n
                const response = await fetch(CONFIG.webhookUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dadosFormulario)
                });

                if (response.ok) {
                    showStep(5);
                } else {
                    throw new Error('Erro ao salvar');
                }
            } catch (error) {
                // Se webhook falhar, tenta salvar direto no Supabase
                try {
                    const response = await fetch(`${CONFIG.supabaseUrl}/rest/v1/clientes`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'apikey': CONFIG.supabaseKey,
                            'Authorization': `Bearer ${CONFIG.supabaseKey}`,
                            'Prefer': 'return=minimal'
                        },
                        body: JSON.stringify(dadosFormulario)
                    });

                    if (response.ok || response.status === 201) {
                        showStep(5);
                    } else {
                        const errorData = await response.json();
                        throw new Error(errorData.message || 'Erro ao salvar no banco');
                    }
                } catch (dbError) {
                    alert('Erro ao salvar: ' + dbError.message);
                    btn.disabled = false;
                    btn.textContent = '‚úì Cadastrar Cliente';
                }
            }
        }
    </script>
</body>
</html>